<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logger Simple - Authentification</title>
    
    <style>
        :root {
            --primary-color: #00d4aa;
            --primary-dark: #00b894;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --background: #f9fafb;
            --surface: #ffffff;
            --border: #e5e7eb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }
        
        .callback-container {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }
        
        .callback-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .callback-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
        }
        
        .status-message.show {
            display: block;
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .user-preview {
            background: var(--background);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            display: none;
        }
        
        .user-preview.show {
            display: block;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            margin: 0 auto 16px;
            display: block;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .user-email {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            margin: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(0, 212, 170, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--background);
        }
        
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 24px 0;
            gap: 16px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .step.active {
            color: var(--primary-color);
        }
        
        .step.completed {
            color: var(--success);
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .step.active .step-icon {
            background: var(--primary-color);
            color: white;
        }
        
        .step.completed .step-icon {
            background: var(--success);
            color: white;
        }
        
        .debug-info {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 20px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        .toggle-debug {
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-top: 16px;
        }
        
        .toggle-debug:hover {
            color: var(--primary-color);
        }
        
        .api-info {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 14px;
        }
        
        @media (max-width: 480px) {
            .callback-container {
                padding: 24px;
                margin: 20px;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="logo">LS</div>
        
        <h1 class="callback-title">Traitement de l'authentification</h1>
        <p class="callback-subtitle" id="subtitle">
            Veuillez patienter pendant que nous finalisons votre connexion...
        </p>
        
        <!-- Info API -->
        <div id="api-info" class="api-info" style="display: none;">
            <strong>üîß Configuration API :</strong><br>
            <span id="api-url">-</span>
        </div>
        
        <!-- √âtapes de progression -->
        <div class="progress-steps">
            <div class="step active" id="step-verify">
                <div class="step-icon">1</div>
                <span>V√©rification</span>
            </div>
            <div class="step" id="step-token">
                <div class="step-icon">2</div>
                <span>Token</span>
            </div>
            <div class="step" id="step-user">
                <div class="step-icon">3</div>
                <span>Profil</span>
            </div>
            <div class="step" id="step-complete">
                <div class="step-icon">‚úì</div>
                <span>Termin√©</span>
            </div>
        </div>
        
        <!-- Spinner de chargement -->
        <div class="loading-spinner" id="loading"></div>
        
        <!-- Messages de statut -->
        <div id="status-success" class="status-message status-success">
            <strong>‚úÖ Authentification r√©ussie !</strong><br>
            <span id="success-details">Vous avez √©t√© connect√© avec succ√®s.</span>
        </div>
        
        <div id="status-error" class="status-message status-error">
            <strong>‚ùå √âchec de l'authentification</strong><br>
            <span id="error-details">Une erreur s'est produite lors de l'authentification.</span>
        </div>
        
        <div id="status-warning" class="status-message status-warning">
            <strong>‚ö†Ô∏è Attention</strong><br>
            <span id="warning-details">Veuillez v√©rifier les informations ci-dessous.</span>
        </div>
        
        <!-- Aper√ßu utilisateur -->
        <div id="user-preview" class="user-preview">
            <img id="user-avatar" class="user-avatar" src="" alt="Avatar utilisateur">
            <div id="user-name" class="user-name">-</div>
            <div id="user-email" class="user-email">-</div>
        </div>
        
        <!-- Boutons d'action -->
        <div id="action-buttons" style="display: none;">
            <button class="btn btn-primary" onclick="continueToApp()">
                Continuer vers l'application
            </button>
            <button class="btn btn-secondary" onclick="tryAgain()">
                R√©essayer
            </button>
        </div>
        
        <!-- Informations de d√©bogage -->
        <div class="toggle-debug" onclick="toggleDebug()">
            üîß Afficher les infos de d√©bogage
        </div>
        <div id="debug-info" class="debug-info"></div>
    </div>
    
    <script>
        // Configuration avec d√©tection automatique de l'API
        const CONFIG = {
            apiUrl: '', // Sera d√©tect√© automatiquement
            storageKey: 'logger_simple_user',
            stateKey: 'oauth_state'
        };
        
        // D√©tection automatique de l'URL de l'API
        function detectApiUrl() {
            // Essayer diff√©rentes possibilit√©s
            const possibilities = [
                window.location.origin + '/api.php',
                window.location.origin + '/api/index.php',
                window.location.origin + '/oauth/api.php',
                'https://connexion.logger-simple.com/api.php',
                'http://localhost/api.php'
            ];
            
            return possibilities[0]; // Par d√©faut, utiliser la premi√®re
        }
        
        CONFIG.apiUrl = detectApiUrl();
        
        // Logging de d√©bogage
        const debugLogs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            debugLogs.push(logEntry);
            console.log(logEntry);
            
            updateDebugDisplay();
        }
        
        function updateDebugDisplay() {
            const debugElement = document.getElementById('debug-info');
            debugElement.textContent = debugLogs.join('\n');
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        
        function toggleDebug() {
            const debugElement = document.getElementById('debug-info');
            const toggleButton = document.querySelector('.toggle-debug');
            
            if (debugElement.classList.contains('show')) {
                debugElement.classList.remove('show');
                toggleButton.textContent = 'üîß Afficher les infos de d√©bogage';
            } else {
                debugElement.classList.add('show');
                toggleButton.textContent = 'üîß Masquer les infos de d√©bogage';
            }
        }
        
        // Fonctions de mise √† jour de l'interface
        function updateStep(stepId, status = 'active') {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `step ${status}`;
            }
        }
        
        function showMessage(type, title, details) {
            // Masquer le chargement
            document.getElementById('loading').style.display = 'none';
            
            // Masquer tous les messages de statut
            document.querySelectorAll('.status-message').forEach(el => {
                el.classList.remove('show');
            });
            
            // Afficher le message sp√©cifique
            const messageEl = document.getElementById(`status-${type}`);
            if (messageEl) {
                const detailsEl = document.getElementById(`${type}-details`);
                if (detailsEl) {
                    detailsEl.textContent = details;
                }
                messageEl.classList.add('show');
            }
            
            // Mettre √† jour le sous-titre
            document.getElementById('subtitle').textContent = title;
        }
        
        function showUserPreview(user) {
            document.getElementById('user-avatar').src = user.avatar || 'https://via.placeholder.com/80';
            document.getElementById('user-name').textContent = user.username || 'Utilisateur inconnu';
            document.getElementById('user-email').textContent = user.email || 'Pas d\'email fourni';
            document.getElementById('user-preview').classList.add('show');
        }
        
        function showActionButtons() {
            document.getElementById('action-buttons').style.display = 'block';
        }
        
        // Gestionnaire de callback OAuth
        class CallbackHandler {
            constructor() {
                this.urlParams = this.parseUrlParams();
                log('Gestionnaire de callback initialis√©');
                log('Param√®tres URL: ' + JSON.stringify(this.urlParams));
                log('URL API d√©tect√©e: ' + CONFIG.apiUrl);
                
                // Afficher l'info API
                document.getElementById('api-url').textContent = CONFIG.apiUrl;
                document.getElementById('api-info').style.display = 'block';
            }
            
            parseUrlParams() {
                const params = {};
                const urlSearchParams = new URLSearchParams(window.location.search);
                
                for (const [key, value] of urlSearchParams.entries()) {
                    params[key] = value;
                }
                
                return params;
            }
            
            async process() {
                try {
                    log('D√©marrage du traitement du callback OAuth');
                    
                    // V√©rifier les erreurs en premier
                    if (this.urlParams.error) {
                        throw new Error(`Erreur OAuth: ${this.urlParams.error} - ${this.urlParams.error_description || 'Erreur inconnue'}`);
                    }
                    
                    // V√©rifier le code d'autorisation
                    if (!this.urlParams.code) {
                        throw new Error('Aucun code d\'autorisation trouv√© dans l\'URL');
                    }
                    
                    // √âtape 1: V√©rifier l'√©tat
                    updateStep('step-verify', 'active');
                    await this.verifyState();
                    updateStep('step-verify', 'completed');
                    
                    // √âtape 2: √âchanger le code contre un token
                    updateStep('step-token', 'active');
                    const tokenData = await this.exchangeCodeForToken();
                    updateStep('step-token', 'completed');
                    
                    // √âtape 3: R√©cup√©rer les infos utilisateur
                    updateStep('step-user', 'active');
                    const user = await this.getUserInfo(tokenData.access_token);
                    user.access_token = tokenData.access_token;
                    updateStep('step-user', 'completed');
                    
                    // √âtape 4: Termin√©
                    updateStep('step-complete', 'completed');
                    
                    this.handleSuccess(user);
                    
                } catch (error) {
                    log('Erreur lors du traitement du callback: ' + error.message, 'error');
                    this.handleError(error);
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            async verifyState() {
                log('V√©rification du param√®tre state');
                
                const savedState = sessionStorage.getItem(CONFIG.stateKey);
                const urlState = this.urlParams.state;
                
                if (!savedState || !urlState) {
                    throw new Error('Param√®tre state manquant');
                }
                
                if (savedState !== urlState) {
                    throw new Error('Le param√®tre state ne correspond pas');
                }
                
                // Nettoyer l'√©tat stock√©
                sessionStorage.removeItem(CONFIG.stateKey);
                log('V√©rification du state r√©ussie');
            }
            
            async exchangeCodeForToken() {
                log('√âchange du code d\'autorisation contre un token d\'acc√®s');
                
                const appConfig = this.getAppConfig();
                
                const tokenRequest = {
                    grant_type: 'authorization_code',
                    client_id: appConfig.app_id,
                    code: this.urlParams.code,
                    redirect_uri: appConfig.redirect_uri
                };
                
                log('Requ√™te de token: ' + JSON.stringify(tokenRequest));
                
                try {
                    const response = await fetch(CONFIG.apiUrl + '?action=token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(tokenRequest)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(`Erreur de token: ${data.error} - ${data.error_description || 'Erreur inconnue'}`);
                    }
                    
                    log('Token d\'acc√®s re√ßu avec succ√®s');
                    return data;
                    
                } catch (fetchError) {
                    log('√âchec de l\'√©change de token: ' + fetchError.message, 'error');
                    throw fetchError;
                }
            }
            
            async getUserInfo(accessToken) {
                log('R√©cup√©ration des informations utilisateur');
                
                try {
                    const response = await fetch(CONFIG.apiUrl + '?action=user', {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const user = await response.json();
                    
                    if (user.error) {
                        throw new Error(`Erreur d\'info utilisateur: ${user.error} - ${user.error_description || 'Erreur inconnue'}`);
                    }
                    
                    log('Informations utilisateur re√ßues: ' + JSON.stringify(user));
                    return user;
                    
                } catch (fetchError) {
                    log('√âchec de r√©cup√©ration des infos utilisateur: ' + fetchError.message, 'error');
                    throw fetchError;
                }
            }
            
            getAppConfig() {
                // Essayer de r√©cup√©rer depuis sessionStorage
                try {
                    const storedConfig = sessionStorage.getItem('oauth_app_config');
                    if (storedConfig) {
                        return JSON.parse(storedConfig);
                    }
                } catch (e) {
                    log('Impossible de parser la config d\'app stock√©e: ' + e.message, 'warn');
                }
                
                // Configuration de fallback
                return {
                    app_id: this.urlParams.client_id || 'ls_demo_app_12345',
                    redirect_uri: window.location.origin + window.location.pathname
                };
            }
            
            handleSuccess(user) {
                log('Authentification r√©ussie: ' + user.username);
                
                // Stocker les donn√©es utilisateur
                try {
                    localStorage.setItem(CONFIG.storageKey, JSON.stringify(user));
                    log('Donn√©es utilisateur stock√©es dans localStorage');
                } catch (e) {
                    log('Impossible de stocker les donn√©es utilisateur: ' + e.message, 'warn');
                }
                
                // Mettre √† jour l'interface
                showMessage('success', 'Authentification r√©ussie !', `Bienvenue, ${user.username} !`);
                showUserPreview(user);
                
                // G√©rer diff√©rents sc√©narios
                if (this.isPopupWindow()) {
                    this.handlePopupSuccess(user);
                } else {
                    this.handleRedirectSuccess(user);
                }
            }
            
            handleError(error) {
                log('√âchec de l\'authentification: ' + error.message, 'error');
                
                // Mettre √† jour l'interface
                showMessage('error', '√âchec de l\'authentification', error.message);
                showActionButtons();
                
                // G√©rer diff√©rents sc√©narios
                if (this.isPopupWindow()) {
                    this.handlePopupError(error);
                } else {
                    this.handleRedirectError(error);
                }
            }
            
            isPopupWindow() {
                try {
                    return window.opener && window.opener !== window;
                } catch (e) {
                    return false;
                }
            }
            
            handlePopupSuccess(user) {
                log('Gestion du succ√®s popup');
                
                try {
                    // Stocker les donn√©es dans le sessionStorage de l'ouvreur
                    if (window.opener && window.opener.sessionStorage) {
                        window.opener.sessionStorage.setItem('logger_simple_user', JSON.stringify(user));
                    }
                    
                    // Appeler le callback de succ√®s dans l'ouvreur
                    if (window.opener && window.opener.LoggerSimple) {
                        window.opener.LoggerSimple.handleSuccess(user);
                    }
                    
                    // Fermer automatiquement le popup apr√®s un d√©lai
                    setTimeout(() => {
                        window.close();
                    }, 2000);
                    
                } catch (e) {
                    log('Erreur lors de la gestion du succ√®s popup: ' + e.message, 'error');
                    showMessage('warning', 'Succ√®s, mais communication √©chou√©e', 'Veuillez fermer cette fen√™tre manuellement.');
                }
            }
            
            handlePopupError(error) {
                log('Gestion de l\'erreur popup');
                
                try {
                    // Stocker l'erreur dans le sessionStorage de l'ouvreur
                    if (window.opener && window.opener.sessionStorage) {
                        window.opener.sessionStorage.setItem('logger_simple_error', JSON.stringify({
                            error: error.message,
                            description: error.message
                        }));
                    }
                    
                    // Appeler le callback d'erreur dans l'ouvreur
                    if (window.opener && window.opener.LoggerSimple) {
                        window.opener.LoggerSimple.handleError('callback_error', error.message);
                    }
                    
                    // Fermer automatiquement le popup apr√®s un d√©lai
                    setTimeout(() => {
                        window.close();
                    }, 4000);
                    
                } catch (e) {
                    log('Erreur lors de la gestion d\'erreur popup: ' + e.message, 'error');
                }
            }
            
            handleRedirectSuccess(user) {
                log('Gestion du succ√®s par redirection');
                
                // D√©clencher un √©v√©nement personnalis√©
                try {
                    const event = new CustomEvent('ls:login:success', { detail: { user } });
                    window.dispatchEvent(event);
                } catch (e) {
                    log('Impossible de d√©clencher l\'√©v√©nement de succ√®s: ' + e.message, 'warn');
                }
                
                showActionButtons();
            }
            
            handleRedirectError(error) {
                log('Gestion de l\'erreur par redirection');
                
                // D√©clencher un √©v√©nement personnalis√©
                try {
                    const event = new CustomEvent('ls:login:error', { 
                        detail: { error: error.message, description: error.message } 
                    });
                    window.dispatchEvent(event);
                } catch (e) {
                    log('Impossible de d√©clencher l\'√©v√©nement d\'erreur: ' + e.message, 'warn');
                }
            }
        }
        
        // Fonctions d'action
        function continueToApp() {
            // R√©cup√©rer l'URL de redirection depuis diverses sources
            const urlParams = new URLSearchParams(window.location.search);
            let redirectUrl = urlParams.get('redirect_to');
            
            if (!redirectUrl) {
                try {
                    redirectUrl = sessionStorage.getItem('oauth_redirect_url');
                    if (redirectUrl) {
                        sessionStorage.removeItem('oauth_redirect_url');
                    }
                } catch (e) {
                    log('Impossible d\'acc√©der au sessionStorage: ' + e.message, 'warn');
                }
            }
            
            // Redirection par d√©faut
            if (!redirectUrl) {
                redirectUrl = '/';
            }
            
            log('Redirection vers: ' + redirectUrl);
            window.location.href = redirectUrl;
        }
        
        function tryAgain() {
            // Nettoyer toutes les donn√©es stock√©es
            try {
                localStorage.removeItem(CONFIG.storageKey);
                sessionStorage.clear();
            } catch (e) {
                log('Impossible de nettoyer le stockage: ' + e.message, 'warn');
            }
            
            // Retourner au r√©f√©rent ou √† l'accueil
            if (document.referrer) {
                window.location.href = document.referrer;
            } else {
                window.location.href = '/';
            }
        }
        
        // Initialiser quand le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM pr√™t, d√©marrage du traitement du callback');
            
            const handler = new CallbackHandler();
            
            // Ajouter un petit d√©lai pour montrer l'√©tat de chargement
            setTimeout(() => {
                handler.process();
            }, 500);
        });
        
        // G√©rer le changement de visibilit√© de la page (pour la d√©tection popup)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                log('Page masqu√©e');
            } else {
                log('Page visible');
            }
        });
        
        // Gestionnaire d'erreur global
        window.addEventListener('error', function(event) {
            log('Erreur globale: ' + event.error.message, 'error');
        });
        
        // Gestionnaire de d√©chargement
        window.addEventListener('beforeunload', function() {
            log('D√©chargement de la page');
        });
    </script>
</body>
</html>