<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logger Simple - Authentication</title>
    
    <style>
        :root {
            --primary-color: #00d4aa;
            --primary-dark: #00b894;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --background: #f9fafb;
            --surface: #ffffff;
            --border: #e5e7eb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }
        
        .callback-container {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }
        
        .callback-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .callback-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
        }
        
        .status-message.show {
            display: block;
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .user-preview {
            background: var(--background);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            display: none;
        }
        
        .user-preview.show {
            display: block;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            margin: 0 auto 16px;
            display: block;
        }
        
        .user-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .user-email {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            margin: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(0, 212, 170, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--background);
        }
        
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 24px 0;
            gap: 16px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .step.active {
            color: var(--primary-color);
        }
        
        .step.completed {
            color: var(--success);
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .step.active .step-icon {
            background: var(--primary-color);
            color: white;
        }
        
        .step.completed .step-icon {
            background: var(--success);
            color: white;
        }
        
        .debug-info {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 20px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        .toggle-debug {
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-top: 16px;
        }
        
        .toggle-debug:hover {
            color: var(--primary-color);
        }
        
        @media (max-width: 480px) {
            .callback-container {
                padding: 24px;
                margin: 20px;
            }
            
            .progress-steps {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="logo">LS</div>
        
        <h1 class="callback-title">Processing Authentication</h1>
        <p class="callback-subtitle" id="subtitle">
            Please wait while we complete your login...
        </p>
        
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" id="step-verify">
                <div class="step-icon">1</div>
                <span>Verifying</span>
            </div>
            <div class="step" id="step-token">
                <div class="step-icon">2</div>
                <span>Getting Token</span>
            </div>
            <div class="step" id="step-user">
                <div class="step-icon">3</div>
                <span>Loading Profile</span>
            </div>
            <div class="step" id="step-complete">
                <div class="step-icon">✓</div>
                <span>Complete</span>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loading"></div>
        
        <!-- Status Messages -->
        <div id="status-success" class="status-message status-success">
            <strong>✅ Authentication Successful!</strong><br>
            <span id="success-details">You have been successfully logged in.</span>
        </div>
        
        <div id="status-error" class="status-message status-error">
            <strong>❌ Authentication Failed</strong><br>
            <span id="error-details">An error occurred during authentication.</span>
        </div>
        
        <div id="status-warning" class="status-message status-warning">
            <strong>⚠️ Warning</strong><br>
            <span id="warning-details">Please check the information below.</span>
        </div>
        
        <!-- User Preview -->
        <div id="user-preview" class="user-preview">
            <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
            <div id="user-name" class="user-name">-</div>
            <div id="user-email" class="user-email">-</div>
        </div>
        
        <!-- Action Buttons -->
        <div id="action-buttons" style="display: none;">
            <button class="btn btn-primary" onclick="continueToApp()">
                Continue to Application
            </button>
            <button class="btn btn-secondary" onclick="tryAgain()">
                Try Again
            </button>
        </div>
        
        <!-- Debug Information -->
        <div class="toggle-debug" onclick="toggleDebug()">
            🔧 Show Debug Info
        </div>
        <div id="debug-info" class="debug-info"></div>
    </div>
    
    <!-- Include the callback handler script -->
    <script>
        // Inline callback script (you can also include callback.js as external file)
        
        // Configuration
        const CONFIG = {
            apiUrl: 'https://connexion.logger-simple.com/api',
            storageKey: 'logger_simple_user',
            stateKey: 'oauth_state'
        };
        
        // Debug logging
        const debugLogs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            debugLogs.push(logEntry);
            console.log(logEntry);
            
            updateDebugDisplay();
        }
        
        function updateDebugDisplay() {
            const debugElement = document.getElementById('debug-info');
            debugElement.textContent = debugLogs.join('\n');
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        
        function toggleDebug() {
            const debugElement = document.getElementById('debug-info');
            const toggleButton = document.querySelector('.toggle-debug');
            
            if (debugElement.classList.contains('show')) {
                debugElement.classList.remove('show');
                toggleButton.textContent = '🔧 Show Debug Info';
            } else {
                debugElement.classList.add('show');
                toggleButton.textContent = '🔧 Hide Debug Info';
            }
        }
        
        // UI Update Functions
        function updateStep(stepId, status = 'active') {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `step ${status}`;
            }
        }
        
        function showMessage(type, title, details) {
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            
            // Hide all status messages
            document.querySelectorAll('.status-message').forEach(el => {
                el.classList.remove('show');
            });
            
            // Show specific message
            const messageEl = document.getElementById(`status-${type}`);
            if (messageEl) {
                const detailsEl = document.getElementById(`${type}-details`);
                if (detailsEl) {
                    detailsEl.textContent = details;
                }
                messageEl.classList.add('show');
            }
            
            // Update subtitle
            document.getElementById('subtitle').textContent = title;
        }
        
        function showUserPreview(user) {
            document.getElementById('user-avatar').src = user.avatar || 'https://via.placeholder.com/80';
            document.getElementById('user-name').textContent = user.username || 'Unknown User';
            document.getElementById('user-email').textContent = user.email || 'No email provided';
            document.getElementById('user-preview').classList.add('show');
        }
        
        function showActionButtons() {
            document.getElementById('action-buttons').style.display = 'block';
        }
        
        // OAuth Callback Implementation
        class CallbackHandler {
            constructor() {
                this.urlParams = this.parseUrlParams();
                log('Callback handler initialized');
                log('URL parameters: ' + JSON.stringify(this.urlParams));
            }
            
            parseUrlParams() {
                const params = {};
                const urlSearchParams = new URLSearchParams(window.location.search);
                
                for (const [key, value] of urlSearchParams.entries()) {
                    params[key] = value;
                }
                
                return params;
            }
            
            async process() {
                try {
                    log('Starting OAuth callback processing');
                    
                    // Check for errors first
                    if (this.urlParams.error) {
                        throw new Error(`OAuth Error: ${this.urlParams.error} - ${this.urlParams.error_description || 'Unknown error'}`);
                    }
                    
                    // Check for authorization code
                    if (!this.urlParams.code) {
                        throw new Error('No authorization code found in URL');
                    }
                    
                    // Step 1: Verify state
                    updateStep('step-verify', 'active');
                    await this.verifyState();
                    updateStep('step-verify', 'completed');
                    
                    // Step 2: Exchange code for token
                    updateStep('step-token', 'active');
                    const tokenData = await this.exchangeCodeForToken();
                    updateStep('step-token', 'completed');
                    
                    // Step 3: Get user info
                    updateStep('step-user', 'active');
                    const user = await this.getUserInfo(tokenData.access_token);
                    user.access_token = tokenData.access_token;
                    updateStep('step-user', 'completed');
                    
                    // Step 4: Complete
                    updateStep('step-complete', 'completed');
                    
                    this.handleSuccess(user);
                    
                } catch (error) {
                    log('Error during callback processing: ' + error.message, 'error');
                    this.handleError(error);
                }
            }
            
            async verifyState() {
                log('Verifying state parameter');
                
                const savedState = sessionStorage.getItem(CONFIG.stateKey);
                const urlState = this.urlParams.state;
                
                if (!savedState || !urlState) {
                    throw new Error('Missing state parameter');
                }
                
                if (savedState !== urlState) {
                    throw new Error('State parameter mismatch');
                }
                
                // Clear stored state
                sessionStorage.removeItem(CONFIG.stateKey);
                log('State verification successful');
            }
            
            async exchangeCodeForToken() {
                log('Exchanging authorization code for access token');
                
                const appConfig = this.getAppConfig();
                
                const tokenRequest = {
                    grant_type: 'authorization_code',
                    client_id: appConfig.app_id,
                    code: this.urlParams.code,
                    redirect_uri: appConfig.redirect_uri
                };
                
                log('Token request: ' + JSON.stringify(tokenRequest));
                
                const response = await fetch(CONFIG.apiUrl + '/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tokenRequest)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Token Error: ${data.error} - ${data.error_description || 'Unknown error'}`);
                }
                
                log('Access token received successfully');
                return data;
            }
            
            async getUserInfo(accessToken) {
                log('Fetching user information');
                
                const response = await fetch(CONFIG.apiUrl + '/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const user = await response.json();
                
                if (user.error) {
                    throw new Error(`User Info Error: ${user.error} - ${user.error_description || 'Unknown error'}`);
                }
                
                log('User information received: ' + JSON.stringify(user));
                return user;
            }
            
            getAppConfig() {
                // Try to get from sessionStorage
                try {
                    const storedConfig = sessionStorage.getItem('oauth_app_config');
                    if (storedConfig) {
                        return JSON.parse(storedConfig);
                    }
                } catch (e) {
                    log('Cannot parse stored app config: ' + e.message, 'warn');
                }
                
                // Fallback configuration
                return {
                    app_id: this.urlParams.client_id || 'ls_demo_app_12345',
                    redirect_uri: window.location.origin + window.location.pathname
                };
            }
            
            handleSuccess(user) {
                log('Authentication successful: ' + user.username);
                
                // Store user data
                try {
                    localStorage.setItem(CONFIG.storageKey, JSON.stringify(user));
                    log('User data stored in localStorage');
                } catch (e) {
                    log('Cannot store user data: ' + e.message, 'warn');
                }
                
                // Update UI
                showMessage('success', 'Authentication Successful!', `Welcome back, ${user.username}!`);
                showUserPreview(user);
                
                // Handle different scenarios
                if (this.isPopupWindow()) {
                    this.handlePopupSuccess(user);
                } else {
                    this.handleRedirectSuccess(user);
                }
            }
            
            handleError(error) {
                log('Authentication failed: ' + error.message, 'error');
                
                // Update UI
                showMessage('error', 'Authentication Failed', error.message);
                showActionButtons();
                
                // Handle different scenarios
                if (this.isPopupWindow()) {
                    this.handlePopupError(error);
                } else {
                    this.handleRedirectError(error);
                }
            }
            
            isPopupWindow() {
                try {
                    return window.opener && window.opener !== window;
                } catch (e) {
                    return false;
                }
            }
            
            handlePopupSuccess(user) {
                log('Handling popup success');
                
                try {
                    // Store data in opener's sessionStorage
                    if (window.opener && window.opener.sessionStorage) {
                        window.opener.sessionStorage.setItem('logger_simple_user', JSON.stringify(user));
                    }
                    
                    // Call success callback in opener
                    if (window.opener && window.opener.LoggerSimple) {
                        window.opener.LoggerSimple.handleSuccess(user);
                    }
                    
                    // Auto-close popup after delay
                    setTimeout(() => {
                        window.close();
                    }, 2000);
                    
                } catch (e) {
                    log('Error handling popup success: ' + e.message, 'error');
                    showMessage('warning', 'Success, but Communication Failed', 'Please close this window manually.');
                }
            }
            
            handlePopupError(error) {
                log('Handling popup error');
                
                try {
                    // Store error in opener's sessionStorage
                    if (window.opener && window.opener.sessionStorage) {
                        window.opener.sessionStorage.setItem('logger_simple_error', JSON.stringify({
                            error: error.message,
                            description: error.message
                        }));
                    }
                    
                    // Call error callback in opener
                    if (window.opener && window.opener.LoggerSimple) {
                        window.opener.LoggerSimple.handleError('callback_error', error.message);
                    }
                    
                    // Auto-close popup after delay
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                    
                } catch (e) {
                    log('Error handling popup error: ' + e.message, 'error');
                }
            }
            
            handleRedirectSuccess(user) {
                log('Handling redirect success');
                
                // Dispatch custom event
                try {
                    const event = new CustomEvent('ls:login:success', { detail: { user } });
                    window.dispatchEvent(event);
                } catch (e) {
                    log('Cannot dispatch success event: ' + e.message, 'warn');
                }
                
                showActionButtons();
            }
            
            handleRedirectError(error) {
                log('Handling redirect error');
                
                // Dispatch custom event
                try {
                    const event = new CustomEvent('ls:login:error', { 
                        detail: { error: error.message, description: error.message } 
                    });
                    window.dispatchEvent(event);
                } catch (e) {
                    log('Cannot dispatch error event: ' + e.message, 'warn');
                }
            }
        }
        
        // Action Functions
        function continueToApp() {
            // Get redirect URL from various sources
            const urlParams = new URLSearchParams(window.location.search);
            let redirectUrl = urlParams.get('redirect_to');
            
            if (!redirectUrl) {
                try {
                    redirectUrl = sessionStorage.getItem('oauth_redirect_url');
                    if (redirectUrl) {
                        sessionStorage.removeItem('oauth_redirect_url');
                    }
                } catch (e) {
                    log('Cannot access sessionStorage: ' + e.message, 'warn');
                }
            }
            
            // Default redirect
            if (!redirectUrl) {
                redirectUrl = '/';
            }
            
            log('Redirecting to: ' + redirectUrl);
            window.location.href = redirectUrl;
        }
        
        function tryAgain() {
            // Clear any stored data
            try {
                localStorage.removeItem(CONFIG.storageKey);
                sessionStorage.clear();
            } catch (e) {
                log('Cannot clear storage: ' + e.message, 'warn');
            }
            
            // Go back to referrer or home
            if (document.referrer) {
                window.location.href = document.referrer;
            } else {
                window.location.href = '/';
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM ready, starting callback processing');
            
            const handler = new CallbackHandler();
            
            // Add small delay to show the loading state
            setTimeout(() => {
                handler.process();
            }, 500);
        });
        
        // Handle page visibility change (for popup detection)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                log('Page became hidden');
            } else {
                log('Page became visible');
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            log('Global error: ' + event.error.message, 'error');
        });
        
        // Unload handler
        window.addEventListener('beforeunload', function() {
            log('Page unloading');
        });
    </script>
</body>
</html>